---
title: Notes on calculating combined GAM estimates within the Rapid Assessment Method (RAM)
author: ""
date: '`r format(Sys.Date(), "%d %B %Y")`'
fontsize: 12pt
geometry: margin=2cm
documentclass: article
classoption: a4paper
bibliography: bibliography.bib
lot: FALSE
lof: FALSE
link-citations: TRUE
links-as-notes: FALSE
colorlinks: TRUE
linkcolor: blue
citecolor: blue
urlcolor: blue
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)

if(!require(ggplot2)) install.packages("ggplot2")
if(!require(magrittr)) install.packages("magrittr")

themeSettings <- theme_bw() + 
  theme(panel.border = element_rect(colour = "#993300",
                                    size = 0.5),
        panel.grid.major = element_line(linetype = 1, 
                                        size = 0.2, 
                                        colour = "gray90"),
        panel.grid.minor = element_line(linetype = 0),
        strip.background = element_rect(colour = "#993300",
                                        fill = "#993300"),
        strip.text = element_text(colour = "white"),
        legend.key = element_rect(linetype = 0),
        axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        axis.ticks = element_line(colour = "#993300", size = 0.5))

```

\newpage

# Background

# Possible approach

PROBIT gives a probability so we look to combining two probabilities:

$$ P(GAM_{\text{MUAC}} ~ \cup ~ GAM_{\text{WHZ}}) ~ = ~ P(GAM_{\text{MUAC}}) ~ + ~ P(GAM_{\text{WHZ}}) $$

However, the problem is that we do not have `independent` probabilities. We overestimate because the intersection gets counted twice. Therefore we need:

$$ P(GAM_{\text{MUAC}} ~ \cup ~ GAM_{\text{WHZ}}) ~ = ~ P(GAM_{\text{MUAC}}) ~ + ~ P(GAM_{\text{WHZ}}) ~ - ~ P(GAM_{\text{MUAC}} ~ \cap ~ GAM_{\text{WHZ}}) $$

We have the first two terms but not the third. We can estimate the third term from a 2 by 2 table:

```{r twoByTwo, echo = FALSE, eval = TRUE}
twoByTwo <- data.frame(rbind(c("a", "b"), c("c", "d")))
row.names(twoByTwo) <- c("MUAC $<$ 125", "MUAC $\\geq$ 125")

knitr::kable(x = twoByTwo,
             booktabs = TRUE,
             row.names = TRUE,
             col.names = c("WHZ $<$ -2", "WHZ $\\geq$ -2"),
             align = "c",
             escape = FALSE,
             format = "latex") %>%
  kableExtra::row_spec(row = 0, bold = TRUE) %>%   
  kableExtra::column_spec(column = 1, bold = TRUE) %>%
  kableExtra::row_spec(row = 1:2, monospace = TRUE) %>%
  kableExtra::column_spec(column = 1:3, monospace = TRUE) %>%
  kableExtra::kable_styling(latex_options = c("striped", "HOLD_position"), font_size = 14)
```

and

$$ P(GAM_{\text{MUAC}} ~ \cap ~ GAM_{\text{WHZ}}) ~ = ~ \frac{a}{a ~ + ~ b ~ + ~ c ~ + ~ d} $$

We have a small sample size so the estimate will lack precision but I think that being "clever" and using something like:

$$ P(GAM_{\text{MUAC}} ~ \cap ~ GAM_{\text{WHZ}}) ~ = ~ P(GAM_{\text{MUAC}}) ~ \times ~ P(GAM_{\text{WHZ}}) $$

will not work as it assumes independence. We can try to move forward with this hybrid method.

\newpage

We try this in R using a dataset from Uganda.

```{r example, echo = TRUE, eval = TRUE}
## Read dataset
x <- read.table(file = "data/ugan01.csv", header = TRUE, sep = ",")

## Case definitions
x$gamWHZ <- ifelse(x$whz < -2, 1, 2)
x$gamMUAC <- ifelse(x$muac < 125, 1, 2)
x$cGAM <- ifelse(x$whz < -2 | x$muac < 125, 1, 2)

## Classic prevalence
round(prop.table(table(x$gamMUAC))[1] * 100, 2)

round(prop.table(table(x$gamWHZ))[1] * 100, 2)

round(prop.table(table(x$cGAM))[1] * 100, 2)

## Test if the two case definitions are independent
chisq.test(table(x$gamMUAC, x$gamWHZ))$p.value

## Simple PROBIT prevalence
pMUAC <- pnorm(125, mean(x$muac), sd(x$muac))
pWHZ <- pnorm(-2, mean(x$whz), sd(x$whz))

## Estimate the UNION probability
pUNION <- table(x$gamMUAC, x$gamWHZ)[1,1] / sum(table(x$gamMUAC, x$gamWHZ))

## cGAM by PROBIT
round((pMUAC + pWHZ - pUNION) * 100, 2)
```